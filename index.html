<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CineArena — Clappr Player</title>

  <!-- Clappr CDN -->
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; background: #000; color: #fff; font-family: Arial, sans-serif; }
    #player { width: 100%; height: 100vh; }
    .info { position: absolute; left: 12px; top: 12px; z-index: 999; background: rgba(0,0,0,0.5); padding: 8px 10px; border-radius: 6px; }
    .fallback { text-align: center; padding: 18px; background: #111; color: #eee; }
    a.fallback-link { color: #ffd54f; word-break: break-all; }
  </style>
</head>
<body>

  <div class="info">Clappr Player — proxy: <span id="proxyLabel"></span></div>
  <div id="player"></div>

  <div id="fallback" class="fallback" style="display:none;">
    <p>If the player fails, try opening the direct or proxied file link below:</p>
    <p><a id="proxiedLink" class="fallback-link" target="_blank" rel="noopener noreferrer"></a></p>
    <p><a id="directLink" class="fallback-link" target="_blank" rel="noopener noreferrer"></a></p>
  </div>

<script>
/**
 * Configuration
 * - proxyBase: your Cloudflare Worker proxy (must accept ?url=)
 * - defaultSource: relative path to default file (we encode it via encodeURIComponent)
 */
const proxyBase = "https://cineproxy.asifansarieng.workers.dev/?url=";
const defaultSource = "http://103.145.232.246/Data/movies/Bollywood/2025/Ek%20Deewane%20Ki%20Deewaniyat%20(2025)/Ek%20Deewane%20Ki%20Deewaniyat.mp4";

// grab ?file= from page URL (the file must be a full URL, e.g. http://host/path/movie.mp4)
function getQueryParam(key) {
  return new URLSearchParams(window.location.search).get(key);
}

const fileParam = getQueryParam("file");
const chosenFile = fileParam ? decodeURIComponent(fileParam) : defaultSource;

// Build proxied URL (pass the original absolute URL as worker ?url= param)
const proxiedUrl = proxyBase + encodeURIComponent(chosenFile);

// Update UI labels
document.getElementById("proxyLabel").textContent = proxyBase.replace(/\/\?url=.*$/,'/?url=');
document.getElementById("proxiedLink").href = proxiedUrl;
document.getElementById("proxiedLink").textContent = proxiedUrl;
document.getElementById("directLink").href = chosenFile;
document.getElementById("directLink").textContent = chosenFile;

// Clappr player setup
const player = new Clappr.Player({
  source: proxiedUrl,
  parentId: "#player",
  autoPlay: true,
  mute: false,
  height: "100%",
  width: "100%",
  playback: {
    failureCallback: (error) => {
      // Clappr internal failure callback (some versions support this)
      showFallback(error ? String(error) : "Playback error");
    }
  },
  events: {
    onError: function(evt) {
      // Called on player error — show fallback info
      console.warn("Clappr error:", evt);
      showFallback("Player error - see console for details");
    },
    onPlay: function() {
      // hide fallback if playing
      document.getElementById("fallback").style.display = "none";
    },
    onBuffering: function() { /* optional: show loading UI */ }
  }
});

// Extra guard: if the player never starts in X seconds show fallback
let started = false;
player.listenTo(player.core.mediaControl, Clappr.Events.PLAYBACK_PLAY, () => { started = true; });
setTimeout(() => {
  if (!started) showFallback("Playback did not start (timeout)");
}, 8000);

// Fallback UI function
function showFallback(message) {
  console.log("Showing fallback:", message);
  document.getElementById("fallback").style.display = "block";
}

// Helpful console log
console.log("Playing via proxy:", proxiedUrl);
</script>

</body>
</html>
